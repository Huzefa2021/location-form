<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto‑Fill Via GPS‑Photo OCR</title>

  <!-- Tesseract.js (browser OCR) -->
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <style>
    body{font-family:Arial,Helvetica;background:#f0f8ff;padding:22px}
    h2{color:#0056b3}
    input[type=file]{margin:14px 0}
    button{padding:10px 20px;margin-top:12px;background:#007BFF;color:#fff;border:none;border-radius:5px;font-size:15px;cursor:pointer}
    button:hover{background:#0056b3}
    #log{margin-top:22px;max-height:280px;overflow-y:auto;background:#fff;border:1px solid #007BFF;border-radius:4px;padding:12px;white-space:pre-line;font-size:14px;color:#333}
    #redirectBtn{display:none}
  </style>
</head>
<body>
  <h2>1️⃣ Upload GPS‑stamped Photo</h2>
  <input type="file" id="imgFile" accept="image/*" />
  <button onclick="runOCR()">Extract & Detect</button>
  <button id="redirectBtn" onclick="window.location.href=redirectUrl">Go to Google Form</button>

  <div id="log"><strong>Debug Log:</strong>\n</div>

<script>
let geojsonData=null, redirectUrl="";

function log(m){const box=document.getElementById('log');box.textContent+=m+'\n';box.scrollTop=box.scrollHeight;console.log(m)}

async function loadGeoJson(){try{const r=await fetch('map.geojson',{cache:'no-store'});geojsonData=await r.json();log('GeoJSON loaded ('+geojsonData.features.length+' features)');}catch(e){log('GeoJSON load error: '+e.message);} }

function isValidPoly(f){return f&&f.geometry&&f.geometry.type==='Polygon'&&f.geometry.coordinates&&f.geometry.coordinates.length}
function getWardBeat(lat,lon){if(!geojsonData)return{ward:'NA',beat:'NA'};const pt=turf.point([lon,lat]);for(const f of geojsonData.features){try{if(!isValidPoly(f))continue;if(turf.booleanPointInPolygon(pt,f))return{ward:f.properties.ward||f.properties.Ward||'NA',beat:f.properties.name||'NA'};}catch{}}return{ward:'NA',beat:'NA'};}

function extractData(text){const latlon=text.match(/Lat\s*([\d\.]+)[^\d]+Long\s*([\d\.]+)/i);
  const dt=text.match(/(\d{2}\/\d{2}\/\d{4}).*?(\d{2}:\d{2}\s*[AP]M)/i);
  const addr=text.match(/\d+.*Mumbai.*\d{6}/i);
  return {lat:latlon?parseFloat(latlon[1]):NaN, lon:latlon?parseFloat(latlon[2]):NaN, date:dt?dt[1]:'', time:dt?dt[2]:'', address:addr?addr[0]:''}; }

async function runOCR(){const file=document.getElementById('imgFile').files[0];if(!file){alert('Select an image first');return;}
  log('⏳ OCR running …');
  const {data:{text}}=await Tesseract.recognize(await file.arrayBuffer(),'eng',{logger:m=>log(m.status+' '+(m.progress*100).toFixed(0)+'%')});
  log('\n--- OCR TEXT ---\n'+text+'\n----------------');
  const data=extractData(text);
  if(isNaN(data.lat)||isNaN(data.lon)){alert('Latitude / Longitude not found in image overlay');return;}
  log(`Parsed → Lat:${data.lat}, Lon:${data.lon}, Date:${data.date}, Time:${data.time}`);

  const zone=getWardBeat(data.lat,data.lon);
  log(`Detected Ward: ${zone.ward}, Beat: ${zone.beat}`);

  // Reverse geocode optional (skip API to stay free) – we already have address from overlay
  const fullAddr=data.address;

  // build Google‑Form pre‑fill
  const form='https://docs.google.com/forms/d/e/1FAIpQLSeo-xlOSxvG0IwtO5MkKaTJZNJkgTsmgZUw-FBsntFlNdRnCw/viewform';
  const params=new URLSearchParams({
    'entry.1625337207':zone.ward,
    'entry.1058310891':zone.beat,
    'entry.1188611077':fullAddr,
    'entry.113122688':data.lat,
    'entry.419288992':data.lon,
    'entry.1911996449':data.date+' '+data.time  // Date & Time (photo overlay)
  });
  redirectUrl=`${form}?${params.toString()}`;
  log('Prepared redirect URL');
  document.getElementById('redirectBtn').style.display='inline-block'; }

window.onload=loadGeoJson;
</script>
</body>
</html>
