<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto-Fill Location (Debug Mode)</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #log { white-space: pre-line; background: #f5f5f5; padding: 10px; border: 1px solid #ccc; margin-top: 20px; }
    #redirectButton { display: none; margin: 10px; padding: 10px; background-color: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #redirectButton:hover { background-color: #0056b3; }
  </style>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    let redirectUrl = "https://forms.gle/UxWpzadJUv7eenpm7";
    let geojsonData = null;

    function log(msg) {
      const logBox = document.getElementById("log");
      logBox.textContent += msg + "\n";
      console.log(msg);
    }

    async function loadGeoJson() {
      try {
        const res = await fetch("map.json", { cache: "no-store" });
        geojsonData = await res.json();
        log("GeoJSON data loaded.");
        return true;
      } catch (e) {
        log("Failed to load GeoJSON: " + e.message);
        return false;
      }
    }

    function getWardAndBeat(lat, lon) {
      if (!geojsonData) return { ward: "NA", beat: "NA" };
      const pt = turf.point([lon, lat]);
      log("Checking against all polygons in map.json...");
      for (const feature of geojsonData.features) {
        const beatName = feature.properties.name || "[Unnamed]";
        const wardName = feature.properties.Ward || "[No Ward]";
        const inside = turf.booleanPointInPolygon(pt, feature);
        log(` → ${beatName} (Ward: ${wardName}): ${inside ? "✔ MATCH" : "✘ not inside"}`);
        if (inside) {
          log("✔ Point lies inside polygon: " + beatName);
          return {
            ward: feature.properties.Ward || "NA",
            beat: feature.properties.name || "NA"
          };
        }
      }
      log("❌ Point does not lie in any polygon.");
      return { ward: "NA", beat: "NA" };
    }

    async function detectAndRedirect() {
      log("Starting location detection...");

      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser");
        log("Browser does not support geolocation");
        return;
      }

      navigator.geolocation.getCurrentPosition(async function(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        log(`Location received: Latitude=${lat}, Longitude=${lon}`);

        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`, {
          headers: { 'Accept-Language': 'en' }
        });

        const data = await response.json();
        const road = data.address.road || "";
        const landmark = data.address.neighbourhood || data.address.suburb || data.address.village || data.address.hamlet || "";
        const town = data.address.town || data.address.city || data.address.county || "";
        const state = data.address.state || "";

        const fullAddress = [road, landmark, town, state].filter(Boolean).join(", ");
        log(`Reverse geocoded address: ${fullAddress}`);

        const zone = getWardAndBeat(lat, lon);
        log(`Detected Ward: ${zone.ward}, Beat: ${zone.beat}`);

        if (zone.ward === "NA" || zone.beat === "NA") {
          alert("⚠ Unable to detect ward/beat for your location. Please proceed manually.");
        }

        const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSeo-xlOSxvG0IwtO5MkKaTJZNJkgTsmgZUw-FBsntFlNdRnCw/viewform";

        const params = new URLSearchParams({
          "entry.1625337207": zone.ward,
          "entry.1058310891": zone.beat,
          "entry.1188611077": fullAddress,
          "entry.113122688": lat,
          "entry.419288992": lon
        });

        redirectUrl = `${formUrl}?${params.toString()}`;
        log("Prepared redirect URL: " + redirectUrl);
        document.getElementById("redirectButton").style.display = "inline-block";

        setTimeout(() => {
          log("Auto redirecting...");
          window.location.href = redirectUrl;
        }, 4000);

      }, function(error) {
        let message = "Location access is required to proceed.\n\n";
        if (error.code === 1) {
          message += "Please enable location permissions in your browser settings and reload the page.";
        } else if (error.code === 2) {
          message += "Location position unavailable. Please try again later.";
        } else if (error.code === 3) {
          message += "Location request timed out. Please reload and try again.";
        } else {
          message += error.message;
        }
        alert(message);
        log("Geolocation error: " + message);
        document.getElementById("retryButton").style.display = "inline-block";
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    function manualRedirect() {
      if (redirectUrl) {
        window.location.href = redirectUrl;
      } else {
        alert("Location not yet captured. Please wait or try again.");
        log("Manual redirect failed – no URL available");
      }
    }

    window.onload = async () => {
      const loaded = await loadGeoJson();
      if (loaded) detectAndRedirect();
      else log("GeoJSON could not be loaded. Cannot proceed.");
    };
  </script>
</head>
<body>
  <h2>Getting your location...</h2>
  <p>Please wait, we are redirecting you to the Google Form.</p>

  <button id="retryButton" onclick="detectAndRedirect()" style="display:none; margin: 10px;">Retry Location Detection</button>
  <button id="redirectButton" onclick="manualRedirect()">Go to Google Form Now</button>

  <div id="log"><strong>Debug Log:</strong>\n</div>
</body>
</html>
