<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto-Fill Location</title>
  <script>
    let redirectUrl = "";

    function detectAndRedirect() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser");
        return;
      }

      navigator.geolocation.getCurrentPosition(async function(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        // Reverse geocode using Nominatim (OpenStreetMap)
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`, {
          headers: {
            'Accept-Language': 'en'
          }
        });

        const data = await response.json();
        const address = data.display_name || "";

        // Optional: Extract ward/beat logic based on address
        let ward = "";
        let beat = "";

        if (address.includes("Worli")) {
          ward = "G/S";
          beat = "4";
        } else if (address.includes("Kurla")) {
          ward = "L";
          beat = "2";
        }
        // Add more mappings as required

        // Google Form base URL
        const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSeo-xlOSxvG0IwtO5MkKaTJZNJkgTsmgZUw-FBsntFlNdRnCw/viewform";

        // Construct prefill parameters
        const params = new URLSearchParams({
          "entry.1625337207": ward,       // Ward
          "entry.1058310891": beat,       // Beat
          "entry.1188611077": address,    // Address
          "entry.113122688": lat,         // Latitude
          "entry.419288992": lon          // Longitude
        });

        redirectUrl = `${formUrl}?${params.toString()}`;
        document.getElementById("manualRedirect").style.display = "inline-block";
        window.location.href = redirectUrl;

      }, function(error) {
        let message = "Location access is required to proceed.\n\n";
        if (error.code === 1) {
          message += "Please enable location permissions in your browser settings and reload the page.";
        } else if (error.code === 2) {
          message += "Location position unavailable. Please try again later.";
        } else if (error.code === 3) {
          message += "Location request timed out. Please reload and try again.";
        } else {
          message += error.message;
        }
        alert(message);
        document.getElementById("retryButton").style.display = "inline-block";
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    function manualRedirect() {
      if (redirectUrl) {
        window.location.href = redirectUrl;
      } else {
        alert("Location not yet captured. Please wait or try again.");
      }
    }
  </script>
</head>
<body>
  <h2>Getting your location...</h2>
  <p>Please wait, we are redirecting you to the Google Form.</p>
  <button id="retryButton" onclick="detectAndRedirect()" style="display:none; margin: 10px;">Retry Location Detection</button>
  <button id="manualRedirect" onclick="manualRedirect()" style="display:none; margin: 10px;">Go to Form Manually</button>
</body>
</html>
